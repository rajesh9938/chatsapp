<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FD WhatsApp Chat</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { margin:0; font-family: Arial,sans-serif; background:#111; display:flex; justify-content:center; align-items:center; height:100vh; }
.phone { width:100%; max-width:420px; height:100vh; max-height:800px; background:#efeae2; display:flex; flex-direction:column; }
#login { flex:1; display:flex; justify-content:center; align-items:center; }
.login-box { background:white; padding:25px; border-radius:12px; width:85%; text-align:center; }
#chat { display:none; flex:1; flex-direction:column; }
.header { background:#075e54; color:white; padding:14px; text-align:center; font-weight:bold; }
.messages { flex:1; padding:10px; overflow-y:auto; }
.message { max-width:75%; padding:8px 12px; margin:6px 0; border-radius:8px; font-size:14px; }
.sent { background:#dcf8c6; margin-left:auto; border-bottom-right-radius:0; }
.received { background:white; margin-right:auto; border-bottom-left-radius:0; }
.sender-name { font-size:11px; color:#555; margin-bottom:3px; font-weight:bold; }
.footer { display:flex; padding:8px; background:#f0f0f0; }
.footer input { flex:1; padding:12px; border-radius:20px; border:none; outline:none; font-size:14px; }
.footer button { margin-left:8px; padding:12px 16px; border:none; border-radius:50%; background:#075e54; color:white; font-size:16px; }
.notification { text-align:center; font-size:12px; color:#666; margin:6px 0; }
</style>
</head>

<body>
<div class="phone">

<!-- LOGIN -->
<div id="login">
    <div class="login-box">
        <h3>Select Your Name</h3>
        <select id="username">
            <option value="">Choose</option>
            <option value="jatin">Jatin</option>
            <option value="rajesh">Rajesh</option>
            <option value="kartik">Kartik</option>
        </select><br><br>
        <button onclick="joinChat()">Enter Chat</button>
    </div>
</div>

<!-- CHAT -->
<div id="chat">
    <div class="header" id="chatHeader"></div>
    <div id="messages" class="messages"></div>
    <div class="footer">
        <input id="msg" placeholder="Type a message" onkeydown="handleEnter(event)">
        <button onclick="send()">âž¤</button>
    </div>
</div>

</div>

<script>
let socket;
let myName;

function joinChat() {
    myName = document.getElementById("username").value;
    if (!myName) { alert("Select your name!"); return; }

    document.getElementById("login").style.display = "none";
    document.getElementById("chat").style.display = "flex";
    document.getElementById("chatHeader").innerText = myName;

    if (Notification.permission !== "granted") Notification.requestPermission();

    // Use ws://localhost:8000 for local, wss:// for Render
    let ws_protocol = window.location.protocol === "https:" ? "wss" : "ws";
    socket = new WebSocket(`${ws_protocol}://${window.location.host}/ws/${myName}`);
    // Local
    // socket = new WebSocket(`ws://localhost:8000/ws/${myName}`);


    socket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        const messages = document.getElementById("messages");

        if (data.type === "notification") {
            const n = document.createElement("div");
            n.className = "notification";
            n.innerText = data.text;
            messages.appendChild(n);
            if (Notification.permission === "granted") new Notification("FD Chat", { body: data.text });
            messages.scrollTop = messages.scrollHeight;
            return;
        }

        const div = document.createElement("div");
        div.classList.add("message");
        div.classList.add(data.sender === myName ? "sent" : "received");

        if (data.sender !== myName && data.type === "message") {
            const nameDiv = document.createElement("div");
            nameDiv.className = "sender-name";
            nameDiv.innerText = data.sender;
            div.appendChild(nameDiv);
            if (Notification.permission === "granted") new Notification(data.sender, { body: data.text });
        }

        const textDiv = document.createElement("div");
        textDiv.innerText = data.text;
        div.appendChild(textDiv);
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
    };
}

function send() {
    const input = document.getElementById("msg");
    if (input.value && socket) { socket.send(input.value); input.value = ""; }
}

function handleEnter(e) { if (e.key === "Enter") send(); }
</script>

</body>
</html>
